# AI Multi-Agent Trading System 仕様書
###
 リポジトリ名: OpenRouter-AI-Hedge-Fund

## 1. プロジェクト概要

### 1.1 目的
複数のAIモデルによる合議制で株式の売買判断を行う自動取引システムの構築

### 1.2 対象取引スタイル
- デイトレード（当日内決済）
- スイングトレード（数日〜数週間保有）

### 1.3 技術スタック
- **AIプロバイダー**: OpenRouter（複数モデル並列利用）
- **データソース**: Alpha Vantage API
- **取引API**: Interactive Brokers API / Alpaca API
- **バックエンド**: Python
- **フロントエンド**: React + TypeScript
- **データベース**: PostgreSQL（取引履歴・判断ログ保存）

---

## 2. システムアーキテクチャ

### 2.1 全体構成図
```
[Alpha Vantage API] 
        ↓
[データ取得・前処理ノード]
        ↓
    ┌───┴───┐
    ↓       ↓
[分析AIノード群（並列実行）]
    │
    ├─ [テクニカル分析AI] (例: Claude Sonnet)
    ├─ [ファンダメンタル分析AI] (例: GPT-4)
    ├─ [センチメント分析AI] (例: Gemini Pro)
    ├─ [リスク評価AI] (例: Command R+)
    └─ [モメンタム分析AI] (例: Llama 3)
    │
    ↓
[決議・統合ノード]
    ↓
[リスク管理フィルター]
    ↓
[取引実行ノード] → [Broker API]
    ↓
[結果記録・学習ノード]
```

---

## 3. 各ノード詳細仕様

### 3.1 データ取得・前処理ノード

**責務**
- Alpha Vantage APIから市場データを取得
- データのクリーニングと正規化
- 各分析AIノードに必要な形式に変換

**取得データ**
- リアルタイム株価（1分足、5分足）
- 日足の過去データ（60日分）
- 出来高データ
- テクニカル指標（SMA, EMA, RSI, MACD, Bollinger Bands）
- 企業基本情報（PER, PBR, EPS）
- 関連ニュース（直近24時間）

**出力形式**
```json
{
  "symbol": "AAPL",
  "timestamp": "2025-11-29T10:30:00Z",
  "current_price": 180.25,
  "price_change_1d": 2.5,
  "price_change_1w": -1.2,
  "volume": 50000000,
  "volume_avg_30d": 45000000,
  "technical_indicators": {
    "rsi_14": 65.5,
    "macd": {"value": 1.2, "signal": 0.8},
    "bb_upper": 185.0,
    "bb_lower": 175.0
  },
  "fundamentals": {
    "pe_ratio": 28.5,
    "market_cap": 2800000000000
  },
  "news_sentiment": [
    {"headline": "...", "sentiment_score": 0.7}
  ]
}
```

---

### 3.2 分析AIノード群

各AIノードは独立して分析を行い、判断を出力します。

#### 3.2.1 ノード1: テクニカル分析AI
**モデル**: Claude Sonnet 4 (OpenRouter)

**分析観点**
- チャートパターン認識（ヘッドアンドショルダー、三角持ち合いなど）
- サポート・レジスタンスライン
- トレンド方向の判定
- オシレーター系指標の解釈

**出力形式**
```json
{
  "node_id": "technical_analysis",
  "model": "anthropic/claude-sonnet-4",
  "recommendation": "BUY" | "SELL" | "HOLD",
  "confidence": 0.75,
  "reasoning": "RSIが40から反発し、MACDがゴールデンクロス。20日移動平均線をブレイクアウト。",
  "target_price": 185.0,
  "stop_loss": 177.0,
  "holding_period": "1-3 days"
}
```

#### 3.2.2 ノード2: ファンダメンタル分析AI
**モデル**: GPT-4など(OpenRouter)

**分析観点**
- 財務指標の健全性
- 業績トレンド
- セクター比較
- マクロ経済環境との関連

**出力形式**（同上の構造）

#### 3.2.3 ノード3: センチメント分析AI
**モデル**: Google Gemini Pro (OpenRouter)

**分析観点**
- ニュース記事の感情分析
- SNSトレンド（Twitter/Reddit）
- アナリストレポートの要約
- 市場全体のセンチメント

#### 3.2.4 ノード4: リスク評価AI
**モデル**: Cohere Command R+ (OpenRouter)

**分析観点**
- ボラティリティ評価
- 相関リスク（ポートフォリオ全体との）
- 流動性リスク
- イベントリスク（決算発表、経済指標など）

#### 3.2.5 ノード5: モメンタム分析AI
**モデル**: Meta Llama 3 70B (OpenRouter)

**分析観点**
- 短期的な勢いの強さ
- 出来高トレンド
- 市場参加者の動き
- ブレイクアウトの真贋判定

---

### 3.3 決議・統合ノード

**責務**
- 各AIノードの判断を集約
- 多数決またはスコアリング方式で最終判断
- コンフリクト解決（意見が割れた場合の処理）

**決議アルゴリズム**

**方式1: 加重多数決**
```python
# 各ノードの信頼度を重み付け
weights = {
    "technical": 0.25,
    "fundamental": 0.20,
    "sentiment": 0.20,
    "risk": 0.20,
    "momentum": 0.15
}

# スコア計算
buy_score = sum(vote.confidence * weights[vote.node] 
                for vote in votes if vote.recommendation == "BUY")
sell_score = sum(vote.confidence * weights[vote.node] 
                 for vote in votes if vote.recommendation == "SELL")

# 閾値判定
if buy_score > 0.6:
    final_decision = "BUY"
elif sell_score > 0.6:
    final_decision = "SELL"
else:
    final_decision = "HOLD"
```

**方式2: 全会一致方式（保守的）**
- 全AIが同じ判断（BUY or SELL）の場合のみ実行
- それ以外はHOLD

**出力形式**
```json
{
  "final_decision": "BUY",
  "aggregate_confidence": 0.72,
  "votes": {
    "BUY": 4,
    "SELL": 0,
    "HOLD": 1
  },
  "dissenting_opinions": [
    {
      "node": "risk_evaluation",
      "reason": "ボラティリティが高すぎる"
    }
  ],
  "recommended_position_size": 5000,
  "target_price": 185.0,
  "stop_loss": 177.0
}
```

---

### 3.4 リスク管理フィルター

**責務**
- ポジションサイズの最終調整
- 1銘柄あたりの投資上限チェック
- ポートフォリオ全体のバランス確認
- ストップロス・利確ラインの妥当性検証

**リスク管理ルール**
```python
# 1銘柄あたりの最大投資比率
MAX_POSITION_SIZE = 0.10  # 総資金の10%

# 1日あたりの最大損失許容額
MAX_DAILY_LOSS = 0.02  # 総資金の2%

# 最大同時保有銘柄数
MAX_CONCURRENT_POSITIONS = 10

# ストップロス必須設定
REQUIRE_STOP_LOSS = True
MIN_STOP_LOSS_DISTANCE = 0.03  # 現在価格から3%以上
```

---

### 3.5 取引実行ノード

**責務**
- ブローカーAPIへの注文送信
- 約定確認
- エラーハンドリング

**対応注文タイプ**
- 成行注文（Market Order）
- 指値注文（Limit Order）
- ストップロス注文（Stop Loss）
- トレーリングストップ（Trailing Stop）

**実装例（Alpaca API）**
```python
from alpaca.trading.client import TradingClient
from alpaca.trading.requests import MarketOrderRequest
from alpaca.trading.enums import OrderSide, TimeInForce

def execute_trade(symbol, decision, quantity):
    trading_client = TradingClient(api_key, secret_key)
    
    order_data = MarketOrderRequest(
        symbol=symbol,
        qty=quantity,
        side=OrderSide.BUY if decision == "BUY" else OrderSide.SELL,
        time_in_force=TimeInForce.DAY
    )
    
    order = trading_client.submit_order(order_data)
    return order
```

---

### 3.6 結果記録・学習ノード

**責務**
- 全ての判断と結果をデータベースに保存
- パフォーマンス分析
- AIモデル毎の精度追跡
- フィードバックループの構築

**記録データ**
```sql
CREATE TABLE trade_decisions (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP,
    symbol VARCHAR(10),
    decision VARCHAR(10),
    aggregate_confidence FLOAT,
    entry_price FLOAT,
    exit_price FLOAT,
    profit_loss FLOAT,
    holding_period INTERVAL,
    node_votes JSONB
);

CREATE TABLE node_performance (
    node_id VARCHAR(50),
    model_name VARCHAR(100),
    total_decisions INT,
    accurate_decisions INT,
    accuracy_rate FLOAT,
    avg_profit FLOAT,
    last_updated TIMESTAMP
);
```

---

## 4. ユーザーインターフェース

### 4.1 ダッシュボード機能

**画面1: リアルタイム監視**
- 現在監視中の銘柄リスト
- 各銘柄のAI判断状況（リアルタイム更新）
- ポートフォリオの現在価値と損益

**画面2: AI投票画面**
- 各AIノードの判断を視覚化
- 賛成/反対/保留の投票結果を円グラフで表示
- 各AIの理由を展開可能なカード形式で表示

**画面3: 取引履歴**
- 過去の取引一覧
- フィルタリング機能（日付、銘柄、利益/損失）
- 各取引の詳細（どのAIが何と判断したか）

**画面4: パフォーマンス分析**
- 総合リターンのグラフ
- AIモデル別の勝率と平均利益
- 最も精度の高いAIの特定
- 改善提案の自動生成

### 4.2 インタラクション機能

**手動介入モード**
- AIの判断に対してユーザーが承認/却下
- 却下理由を記録し、学習データに反映

**設定カスタマイズ**
- 監視銘柄の追加/削除
- AIノードの有効/無効切り替え
- リスクパラメータの調整
- 決議方式の切り替え（多数決 or 全会一致）

**バックテストモード**
- 過去データで戦略をシミュレーション
- 異なるAI構成での比較検証

---

## 5. 実装フェーズ

### Phase 1: MVP（最小実行可能製品）
- [ ] Alpha Vantage APIからのデータ取得
- [ ] 3つのAIノード実装（テクニカル、ファンダメンタル、センチメント）
- [ ] 簡単な多数決ロジック
- [ ] Paper Trading環境での検証
- [ ] 基本的なWebダッシュボード

### Phase 2: 機能拡充
- [ ] 残り2つのAIノード追加（リスク、モメンタム）
- [ ] データベース統合
- [ ] リアルタイム取引機能
- [ ] パフォーマンストラッキング

### Phase 3: 最適化・学習
- [ ] AIモデルの動的重み付け調整
- [ ] バックテスト機能の実装
- [ ] アラート機能（Slack/Email通知）
- [ ] 複数ブローカー対応

---

## 6. セキュリティ・コンプライアンス

### 6.1 APIキー管理
- 環境変数での管理（.envファイル）
- 本番環境ではシークレット管理サービス利用（AWS Secrets Manager等）

### 6.2 取引制限
- 1日あたりの最大取引回数制限
- サーキットブレーカー（急激な損失時の自動停止）
- ホワイトリスト銘柄のみ取引

### 6.3 法的考慮事項
- 金融商品取引法の遵守
- アルゴリズム取引の届出（必要に応じて）
- 自己勘定での運用（他人資本は扱わない）

---

## 7. コスト見積もり(ローカル運用なので無視してOK)

### 7.1 API利用料
- **Alpha Vantage**: $49.99/月（Premium プラン）
- **OpenRouter**: 従量課金
  - Claude Sonnet: $3/1M tokens
  - GPT-4: $30/1M tokens（入力）
  - その他モデル: 平均 $5/1M tokens
  - 想定月額: $100-300（取引頻度による）

### 7.2 ブローカー手数料
- **Interactive Brokers**: 1株あたり $0.005（最低$1/注文）
- **Alpaca**: 手数料無料（米国株）

### 7.3 インフラ
- **サーバー**: AWS EC2 t3.medium ($30/月)
- **データベース**: AWS RDS PostgreSQL ($50/月)
- **合計想定コスト**: $230-430/月

---

## 8. リスク想定と対策

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| AIの誤判断による損失 | 高 | 大 | ストップロス必須化、ポジションサイズ制限 |
| API障害 | 中 | 大 | フォールバック先の設定、手動介入モード |
| 過学習（バックテストでのみ機能） | 高 | 大 | Out-of-sample検証、定期的な戦略見直し |
| 規制変更 | 低 | 大 | 法務専門家への定期相談 |
| ブラックスワンイベント | 低 | 極大 | 最大損失額の設定、緊急停止機能 |

---

## 9. 成功指標（KPI）

- **総合リターン**: 年率10%以上
- **シャープレシオ**: 1.5以上
- **最大ドローダウン**: -15%以内
- **勝率**: 55%以上
- **AIコンセンサス時の精度**: 70%以上

---

## 10. 今後の拡張案

- マルチアセット対応（FX、仮想通貨、コモディティ）
- 機械学習モデルの追加（LLM以外の予測モデル）
- ソーシャルトレーディング機能（他ユーザーの戦略をフォロー）
- モバイルアプリ開発
- リアルタイム音声レポート（「今日の取引状況」を音声で要約）

---

## 11. 開発環境・デプロイ

### 11.1 ディレクトリ構成

```
OpenRouter-AI-Hedge-Fund/
├── docker-compose.yml
├── .env.example
├── .env
├── start.bat              # Windows用起動スクリプト
├── start.sh               # Linux/Mac用起動スクリプト
├── backend/
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── main.py
│   ├── nodes/
│   │   ├── data_fetcher.py
│   │   ├── technical_analysis.py
│   │   ├── fundamental_analysis.py
│   │   ├── sentiment_analysis.py
│   │   ├── risk_evaluation.py
│   │   └── momentum_analysis.py
│   ├── orchestrator.py
│   ├── risk_manager.py
│   └── broker_interface.py
├── frontend/
│   ├── Dockerfile
│   ├── package.json
│   ├── src/
│   │   ├── App.tsx
│   │   ├── components/
│   │   └── pages/
│   └── public/
└── database/
    └── init.sql
```

### 11.2 Docker構成

**docker-compose.yml**
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: ai-hedge-db
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build: ./backend
    container_name: ai-hedge-backend
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - ALPHA_VANTAGE_API_KEY=${ALPHA_VANTAGE_API_KEY}
      - ALPACA_API_KEY=${ALPACA_API_KEY}
      - ALPACA_SECRET_KEY=${ALPACA_SECRET_KEY}
      - TRADING_MODE=${TRADING_MODE:-paper}
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - backend_logs:/app/logs
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  frontend:
    build: ./frontend
    container_name: ai-hedge-frontend
    environment:
      - REACT_APP_API_URL=http://localhost:8000
    depends_on:
      - backend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    stdin_open: true
    tty: true

  redis:
    image: redis:7-alpine
    container_name: ai-hedge-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
  backend_logs:
```

### 11.3 環境変数設定

**.env.example**
```bash
# Database
DB_NAME=ai_hedge_fund
DB_USER=trader
DB_PASSWORD=your_secure_password_here

# API Keys
OPENROUTER_API_KEY=sk-or-v1-xxxxx
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_key
ALPACA_API_KEY=your_alpaca_key
ALPACA_SECRET_KEY=your_alpaca_secret

# Trading Settings
# TRADING_MODE: virtual(架空口座) / paper(ペーパー) / live(実運用)
TRADING_MODE=virtual
MAX_POSITION_SIZE=0.10
MAX_DAILY_LOSS=0.02
MAX_CONCURRENT_POSITIONS=10
MIN_STOP_LOSS_DISTANCE=0.03
ACCOUNT_EQUITY=100000

# AI Models Configuration
TECHNICAL_MODEL=anthropic/claude-sonnet-4
FUNDAMENTAL_MODEL=openai/gpt-4
SENTIMENT_MODEL=google/gemini-pro
RISK_MODEL=cohere/command-r-plus
MOMENTUM_MODEL=meta-llama/llama-3-70b

# Decision Algorithm
DECISION_ALGORITHM=weighted_majority  # weighted_majority or unanimous
CONFIDENCE_THRESHOLD=0.6

# Polling Settings
WATCH_SYMBOLS=AAPL,MSFT
POLL_INTERVAL_SECONDS=300
AUTO_TRADE_ENABLED=false

# Discord Notification
DISCORD_WEBHOOK_URL=
DISCORD_ENABLED=false

# NISA / SIP Settings
NISA_ENABLED=false
NISA_SYMBOLS=VT
NISA_INVEST_AMOUNT=30000
NISA_MAX_PRICE=
```

### 11.4 起動スクリプト

**start.bat (Windows)**
```batch
@echo off
echo ================================
echo AI Hedge Fund System Launcher
echo ================================
echo.

REM 環境変数ファイルの確認
if not exist .env (
    echo [ERROR] .env file not found!
    echo Please copy .env.example to .env and configure your API keys.
    pause
    exit /b 1
)

echo [1/4] Checking Docker...
docker --version >nul 2>&1
if errorlevel 1 (
    echo [ERROR] Docker is not installed or not running.
    echo Please install Docker Desktop and start it.
    pause
    exit /b 1
)

echo [2/4] Stopping existing containers...
docker-compose down

echo [3/4] Building and starting containers...
docker-compose up --build -d

echo [4/4] Waiting for services to be ready...
timeout /t 10 /nobreak >nul

echo.
echo ================================
echo System is ready!
echo ================================
echo Frontend: http://localhost:3000
echo Backend API: http://localhost:8000
echo API Docs: http://localhost:8000/docs
echo.
echo To view logs: docker-compose logs -f
echo To stop: docker-compose down
echo.
pause
```

**start.sh (Linux/Mac)**
```bash
#!/bin/bash

echo "================================"
echo "AI Hedge Fund System Launcher"
echo "================================"
echo ""

# 環境変数ファイルの確認
if [ ! -f .env ]; then
    echo "[ERROR] .env file not found!"
    echo "Please copy .env.example to .env and configure your API keys."
    exit 1
fi

# Dockerの確認
if ! command -v docker &> /dev/null; then
    echo "[ERROR] Docker is not installed."
    echo "Please install Docker and try again."
    exit 1
fi

echo "[1/4] Checking Docker..."
if ! docker info &> /dev/null; then
    echo "[ERROR] Docker daemon is not running."
    echo "Please start Docker and try again."
    exit 1
fi

echo "[2/4] Stopping existing containers..."
docker-compose down

echo "[3/4] Building and starting containers..."
docker-compose up --build -d

echo "[4/4] Waiting for services to be ready..."
sleep 10

echo ""
echo "================================"
echo "System is ready!"
echo "================================"
echo "Frontend: http://localhost:3000"
echo "Backend API: http://localhost:8000"
echo "API Docs: http://localhost:8000/docs"
echo ""
echo "To view logs: docker-compose logs -f"
echo "To stop: docker-compose down"
echo ""
```

### 11.5 開発時の便利コマンド

**dev.bat / dev.sh**
```batch
REM 開発モード（ホットリロード有効）
docker-compose up

REM ログ監視
docker-compose logs -f backend

REM 特定サービスの再起動
docker-compose restart backend

REM データベースに接続
docker exec -it ai-hedge-db psql -U trader -d ai_hedge_fund

REM Redisに接続
docker exec -it ai-hedge-redis redis-cli

REM 全コンテナの状態確認
docker-compose ps

REM クリーンビルド（キャッシュなし）
docker-compose build --no-cache

REM すべて削除（ボリュームも含む）
docker-compose down -v
```

### 11.6 本番デプロイ

**AWS ECS / Cloud Run 用の設定**
```yaml
# deploy/production.yml
version: '3.8'

services:
  backend:
    image: ghcr.io/yourname/ai-hedge-backend:latest
    environment:
      - TRADING_MODE=live
      - LOG_LEVEL=INFO
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  frontend:
    image: ghcr.io/yourname/ai-hedge-frontend:latest
    deploy:
      replicas: 2
```

**GitHub Actions CI/CD**
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Build Docker images
        run: |
          docker-compose build
          
      - name: Run tests
        run: |
          docker-compose run backend pytest
          
      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        run: |
          # Your deployment script here
          echo "Deploying to production..."
```

---

**最終更新**: 2025-11-29  
**バージョン**: 1.1  
**作成者**: AI Trading System Project Team